/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/anndata/_core/anndata.py:1840: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates("var")
/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/anndata/_core/anndata.py:1840: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates("var")
/home/yunfei/spatial_dl_integration/MaskGraphene/datasets/data_proc.py:84: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead
See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  Spatial_Net['Cell1'] = Spatial_Net['Cell1'].map(id_cell_trans)
/home/yunfei/spatial_dl_integration/MaskGraphene/datasets/data_proc.py:85: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead
See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  Spatial_Net['Cell2'] = Spatial_Net['Cell2'].map(id_cell_trans)
------Calculating spatial graph...
The graph contains 24762 edges, 4221 cells.
5.8664 neighbors per cell on average.
/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/anndata/_core/anndata.py:1840: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates("var")
/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/anndata/_core/anndata.py:1840: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates("var")
------Calculating spatial graph...
The graph contains 25692 edges, 4381 cells.
5.8644 neighbors per cell on average.
/home/yunfei/spatial_dl_integration/MaskGraphene/datasets/data_proc.py:84: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead
See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  Spatial_Net['Cell1'] = Spatial_Net['Cell1'].map(id_cell_trans)
/home/yunfei/spatial_dl_integration/MaskGraphene/datasets/data_proc.py:85: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead
See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  Spatial_Net['Cell2'] = Spatial_Net['Cell2'].map(id_cell_trans)
Namespace(seeds=[0, 5, 42, 114514, 2023], dataset='DLPFC', exp_fig_dir='/home/yunfei/spatial_dl_integration/GraphMAE2/MG_exps_1014_1', h5ad_save_dir='/home/yunfei/spatial_dl_integration/GraphMAE2/st_dataset', st_data_dir='/home/yunfei/spatial_benchmarking/benchmarking_data/DLPFC12', consecutive_prior=1, section_ids='151507,151508', num_class=7, hvgs=6500, device=3, max_epoch=1500, max_epoch_triplet=700, warmup_steps=-1, num_heads=1, num_out_heads=1, num_layers=2, num_dec_layers=2, num_remasking=1, num_hidden='512,32', residual=False, in_drop=0.0, attn_drop=0.0, norm=None, lr=0.001, weight_decay=0, negative_slope=0.2, activation='elu', mask_rate=0.05, remask_rate=0.05, remask_method='random', mask_type='mask', mask_method='random', drop_edge_rate=0.0, encoder='gat', decoder='gat', loss_fn='sce', alpha_l=2.0, optimizer='adam', linear_prob=False, no_pretrain=False, checkpoint_path=None, use_cfg=False, logging='False', scheduler=False, batch_size=512, sampling_method='saint', label_rate=1.0, data_dir='/home/yunfei/spatial_benchmarking/benchmarking_data', lam=1.0, full_graph_forward=False, delayed_ema_epoch=0, replace_rate=0.0, momentum=0.996, load_model='False', num_features=3088)
=== Use sce_loss and alpha_l=2.0 ===
num_encoder_params: 1599072, num_decoder_params: 1608240, num_params_in_total: 3245826
PreModel(
  (encoder): GAT(
    (gat_layers): ModuleList(
      (0): GATConv(
        (fc): Linear(in_features=3088, out_features=512, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
        (activation): ELU(alpha=1.0)
      )
      (1): GATConv(
        (fc): Linear(in_features=512, out_features=32, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
      )
    )
    (head): Identity()
  )
  (decoder): GAT(
    (gat_layers): ModuleList(
      (0): GATConv(
        (fc): Linear(in_features=32, out_features=512, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
        (activation): ELU(alpha=1.0)
      )
      (1): GATConv(
        (fc): Linear(in_features=512, out_features=3088, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
      )
    )
    (head): Identity()
  )
  (encoder_to_decoder): Linear(in_features=32, out_features=32, bias=False)
  (projector): Sequential(
    (0): Linear(in_features=32, out_features=512, bias=True)
    (1): PReLU(num_parameters=1)
    (2): Linear(in_features=512, out_features=32, bias=True)
  )
  (projector_ema): Sequential(
    (0): Linear(in_features=32, out_features=512, bias=True)
    (1): PReLU(num_parameters=1)
    (2): Linear(in_features=512, out_features=32, bias=True)
  )
  (predictor): Sequential(
    (0): PReLU(num_parameters=1)
    (1): Linear(in_features=32, out_features=32, bias=True)
  )
  (encoder_ema): GAT(
    (gat_layers): ModuleList(
      (0): GATConv(
        (fc): Linear(in_features=3088, out_features=512, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
        (activation): ELU(alpha=1.0)
      )
      (1): GATConv(
        (fc): Linear(in_features=512, out_features=32, bias=False)
        (feat_drop): Dropout(p=0.0, inplace=False)
        (attn_drop): Dropout(p=0.0, inplace=False)
        (leaky_relu): LeakyReLU(negative_slope=0.2)
      )
    )
    (head): Identity()
  )
)
# Epoch 9: train_loss: 0.3149:   1%|█▎                                                                                                                                                                                                | 10/1500 [00:01<01:45, 14.18it/s]
# Epoch 47: train_loss: 0.1185:   3%|██████▏                                                                                                                                                                                          | 48/1500 [00:02<01:17, 18.67it/s]
Traceback (most recent call last):
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/sh_scripts/../maskgraphene_main.py", line 581, in <module>
    a_ari = main(args)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/sh_scripts/../maskgraphene_main.py", line 461, in main
    batchlist_ = run_mask_graphene_aligner(graph, model_local_ot, device, ad_concat, section_ids, max_epoch=max_epoch, max_epoch_triplet=max_epoch_triplet, optimizer=optimizer, scheduler=scheduler, logger=logger, use_mnn=True)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/sh_scripts/../maskgraphene_main.py", line 262, in run_mask_graphene_aligner
    loss = model(graph, x, targets=target_nodes)
  File "/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/models/edcoder.py", line 240, in forward
    loss = self.mask_attr_prediction(g, x, targets, epoch, drop_g1, drop_g2)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/models/edcoder.py", line 248, in mask_attr_prediction
    enc_rep = self.encoder(use_g, use_x,)
  File "/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/models/gat.py", line 80, in forward
    h = self.gat_layers[l](g, h)
  File "/home/yunfei/anaconda3/envs/MG/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/yunfei/spatial_dl_integration/MaskGraphene/models/gat.py", line 268, in forward
    er = (feat_dst * self.attn_r).sum(dim=-1).unsqueeze(-1)
KeyboardInterrupt